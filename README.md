# GL-MT6000 custom OpenWrt firmware builder

This repository automates the process of building OpenWrt custom firmware images for **MY** Flint 2 (GL-MT6000) router, based on **MY PREFERENCES** and [pesa1234](https://github.com/pesa1234)'s work.

You should **not use** the firmwares released in this repository unless you have the same preferences/needs.
Instead, **make a fork and adapt to your needs**.

Read [this topic](https://forum.openwrt.org/t/mt6000-custom-build-with-luci-and-some-optimization-kernel-6-12-x/185241) in OpenWrt's forum to learn the details about pesa1234's customizations.

Compared to his custom firmware, this firmware adds:
- **WiFi UCODE scripts** (faster boot)
- **Wireguard VPN**
- **Policy Based Routing** (select what goes through VPN and what not)
- **AdBlock Fast** (ads and malware blocking at DNS level)
- **PPPoE-ready WAN defaults with IPv6** (1492 MTU, DHCPv6-PD on LAN, packet steering on by default).
- **Cake SQM preconfigured for gigabit fiber** (PPPoE overhead accounted for, capped at 950/950 Mbps to preserve headroom).
- **Cloudflare Dynamic DNS templates** for both A and AAAA records so the router, not your server, keeps DNS in sync.
- **Wake-on-LAN helper script** to power on the homelab server after SSHing into the router.

And also:
- **REMOVED:** upnp, iptables, avahi, samba, usb storage and probably more stuff I forgot to mention (odhcp packages are back to support IPv6 on PPPoE).
- Added the needed packages to use QoS script [cake-wg-pbr](https://github.com/lynxthecat/cake-wg-pbr)
- Some compiler optimizations and build hardening options (cortex-a53+crc+crypto; LTO, MOLD, and more).
- SSH configuration with strong algorithms and key exchange methods. Check the content of [`ssh_hardening.config`](files/etc/ssh/sshd_config.d/ssh_hardening.conf) and [`sshd_config`](files/etc/ssh/sshd_config).
- Quality-of-life enhancements through UCI configuration. Check the content of [`999-QOL_config`](files/etc/uci-defaults/999-QOL_config).
- Some debug and kernel stuff removed.
- [`upgrade_custom_openwrt`](files/usr/bin/upgrade_custom_openwrt) script
- Pre-enabled [OpenWrt SQM](https://openwrt.org/docs/guide-user/network/traffic-shaping/sqm) with Cake tuned for PPPoE fiber connections.
- [`wake_homelab`](files/usr/bin/wake_homelab) helper that calls `etherwake` with your server MAC.
- Dynamic DNS configuration in [`/etc/config/ddns`](files/etc/config/ddns) with placeholders for Cloudflare tokens, zone IDs, and hostnames.

Check the content of [`mt6000.config`](mt6000.config) for details.


## Quick setup checklist

1. **Flash the image** generated by this repository, then log into LuCI at `http://192.168.8.1` (default GL.iNet LAN).
2. **Enter the PPPoE credentials** supplied by your ISP under *Network → Interfaces → WAN*.
3. **Confirm IPv6 is live** by checking that *Status → Overview → WAN6* shows a delegated prefix.
4. **Adjust SQM bandwidth** under *Network → SQM QoS* if your line is slower/faster than 1 Gbps.
5. **Edit `/usr/bin/wake_homelab`** so the helper knows your server’s MAC address and LAN bridge.
6. **Create a Cloudflare API token** with `Zone.DNS` and `Zone.Zone` permissions, drop the token + zone ID into `/etc/config/ddns`, enable the services, and stop `ddclient` on your Debian box.


## PPPoE + IPv6 on the GL-MT6000

The [`010-network-pppoe`](files/etc/uci-defaults/010-network-pppoe) defaults ship the WAN interface in PPPoE mode with MTU 1492, packet steering, and IPv6 auto-negotiation enabled. They also publish delegated prefixes on LAN via DHCPv6 and Router Advertisements so your Arch Linux workstation and Debian 12 homelab pick up stable IPv6 addresses without extra tweaks.

After flashing:

- Navigate to **Network → Interfaces → WAN** in LuCI and replace `CHANGE_ME_PPPoE_USERNAME` / `CHANGE_ME_PPPoE_PASSWORD` with the credentials from your ISP.
- Leave IPv6 set to **Automatic**; the `wan6` companion interface will request a prefix via DHCPv6.
- Under **Network → Interfaces → LAN → DHCP Server → IPv6 Settings**, you should see *RA-Service: server*, *DHCPv6-Service: server*, and *NDP-Proxy: hybrid*—these come from the default configuration and are ready to go.
- Reboot or reconnect your Arch workstation and Debian server, then visit <https://test-ipv6.com> or run `ping -6 ipv6.google.com` to confirm end-to-end IPv6 reachability.


## Traffic shaping with Cake SQM

[`/etc/config/sqm`](files/etc/config/sqm) enables Cake on `pppoe-wan` at 950 Mbit/s up and down so latency stays low even when the fiber link is saturated. If your ISP ever changes the speed, update the *Download* and *Upload* fields under **Network → SQM QoS** and restart the SQM service. Hardware flow offload stays disabled so Cake can accurately shape traffic while still giving you near-gigabit throughput on the MT6000.


## Remote Wake-on-LAN workflow

The [`wake_homelab`](files/usr/bin/wake_homelab) script wraps `etherwake` so you can power on the Ryzen 7700 homelab from anywhere:

1. Enable *PCIe/PCI device power on* (or a similarly named setting) in the ASRock BIOS.
2. Inside Debian 12, make the change persistent with `sudo ethtool -s <interface> wol g` (replace `<interface>` with the NIC that faces the MT6000).
3. Edit `TARGET_MAC` (and `TARGET_INTERFACE` if you bridge VLANs differently) in `/usr/bin/wake_homelab`.
4. Use an SSH key to reach the router on the WAN rule created by the defaults, then trigger the wake-up with `ssh root@<router-public-ip> wake_homelab`.

For safety, keep password logins disabled and consider allowing WAN SSH only from trusted IP ranges via *Network → Firewall → Traffic Rules*.


## Cloudflare Dynamic DNS from the router

The build now ships `ddns-scripts`, the Cloudflare back end, LuCI integration, and a ready-to-edit config in [`/etc/config/ddns`](files/etc/config/ddns):

1. In Cloudflare, create an **API token** limited to the zone that holds your homelab hostname with permissions `Zone.Zone → Read` and `Zone.DNS → Edit`. Copy the Zone ID from the Cloudflare dashboard.
2. SSH into the router and edit `/etc/config/ddns` (or use **Services → Dynamic DNS** in LuCI) to replace:
   - `home.example.com` with `host.example.com` for the record you publish through Cloudflare.
   - `REPLACE_WITH_CLOUDFLARE_API_TOKEN` with the API token you created.
   - `REPLACE_WITH_ZONE_ID` with the Zone ID from Cloudflare.
3. Leave `username` set to `Bearer`. This tells the helper scripts to authenticate using your API token instead of the legacy global key.
4. Enable the IPv4 and IPv6 entries once the placeholders are filled. The router will push both records directly to Cloudflare and log activity under `/var/log/ddns/`.
5. Disable `ddclient` on the Debian server; the router now owns dynamic DNS updates. From Arch, verify the change with `dig host.example.com A` and `dig host.example.com AAAA`.


## Building this firmware

Building through GitHub Actions is unchanged. Trigger the existing **“Build OpenWrt for GL-MT6000”** workflow (manually or by pushing to `main`) and it will pull `mt6000.config`, apply everything under `files/`, and publish firmware artifacts automatically. No extra steps are required beyond what the upstream template already documents.


## About upgrade_custom_openwrt script

I added a script to make upgrading OpenWRT super easy. Just run from a SSH terminal:
- `upgrade_custom_openwrt --now` to check if a newer firmware is available and upgrade if so.
- `upgrade_custom_openwrt --wait` to wait for clients activity to stop before upgrading.
- `upgrade_custom_openwrt --check` to check for new versions but not upgrade the router.

**IT IS NOT RECOMMENDED** to schedule the script to be executed automatically, although the script is very careful and checks sha256sums before trying to upgrade. Don't blame me if something goes wrong with scripts that **YOU** run in your router!

Notes:
- if you fork this repository, the script will be adapted to look for upgrades in your repository.
- The text output of upgrade_custom_openwrt script will show both in terminal and system logs.



## About SSH Hardening

To enhance the security of SSH connections, this firmware includes a hardened SSH configuration. The configuration is derived from recommendations by [SSH-Audit](https://github.com/jtesta/ssh-audit) and the [BSI](https://www.bsi.bund.de/), it specifies strong key exchange algorithms, ciphers, message authentication codes (MACs), host key algorithms, and public key algorithms. This ensures that only secure and up-to-date algorithms are used for SSH communication.



## Contributing

Contributions to this project are welcome. If you encounter any issues or have suggestions for improvements, please open an issue or submit a pull request on the GitHub repository.



## Acknowledgements

- The OpenWrt project for providing the foundation for this firmware build and support of [GL.iNet GL-MT6000](https://openwrt.org/toh/gl.inet/gl-mt6000) router.
- The community over at the [OpenWrt forum](https://forum.openwrt.org/t/mt6000-custom-build-with-luci-and-some-optimization-kernel-6-12-x/185241) for their valuable contributions and resources. 
- [pesa1234](https://github.com/pesa1234) for his [MT6000 custom builds](https://github.com/pesa1234/MT6000_cust_build).
- [Julius Bairaktaris](https://github.com/JuliusBairaktaris/Qualcommax_NSS_Builder) from whom I "borrowed" much of this project (his repository is about custom builds for Xiaomi AX3600).
